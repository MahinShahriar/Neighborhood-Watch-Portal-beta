{% extends "templates/pages/base.html" %}

{% block metaquotes %} 
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block title %}Report an Issue{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-6">
    <h2 class="text-3xl font-semibold mb-6">Report an Issue</h2>

    <form id="issueForm" class="space-y-4" enctype="multipart/form-data">
        <div>
            <label class="block mb-1 font-medium">Category</label> 
            <select id="category" class="w-full p-2 border rounded"> 
                <option value="Water Leakage">Water Leakage</option>
                <option value="Electricity Outage">Electricity Outage</option>
                <option value="Garbage">Garbage</option>
                <option value="Noise Complaints">Noise Complaints</option>
            </select> 
        </div> 
        <div> 
            <label class="block mb-1 font-medium">Severity</label> 
            <select id="severity" class="w-full p-2 border rounded"> 
                <option value="Low">Low</option> 
                <option value="Medium">Medium</option> 
                <option value="High">High</option> 
            </select> 
        </div> 
        <div> 
            <label class="block mb-1 font-medium">Description</label> 
            <textarea id="description" rows="4" class="w-full p-2 border rounded" placeholder="Describe the issue..."></textarea> 
        </div> 
        <div> 
            <label class="block mb-1 font-medium">Upload File</label> 
            <input type="file" id="file" class="w-full" accept=".jpg,.jpeg,.png,.pdf" onchange="previewFile()" />
            <img id="preview" class="mt-2 hidden max-h-60 rounded border" /> 
        </div> 
        <button type="button" onclick="submitIssue()" class="w-full bg-blue-600 text-white p-3 rounded text-lg"> Submit Issue </button>
    </form>

    <p id="msg" class="mt-4"></p>
</div>

<script>
    function previewFile() {
    const file = document.getElementById("file").files[0];
    const preview = document.getElementById("preview");

    if (!file || !file.type.startsWith("image/")) {
        preview.classList.add("hidden");
        return;
    }

    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
}
async function submitIssue() {
    const msg = document.getElementById("msg");

    const fd = new FormData();
    fd.append("category", document.getElementById("category").value);
    fd.append("severity", document.getElementById("severity").value);
    fd.append("description", document.getElementById("description").value);

    const fileInput = document.getElementById("file");
    if (fileInput.files.length > 0) {
        fd.append("file", fileInput.files[0]);
    }

    msg.innerHTML = "Submitting...";

    try {
        const res = await fetch(
            "/api/method/neighborhood_watch.api.issue_api.submit_issue",
            {
                method: "POST",
                body: fd,
                credentials: "same-origin"
            }
        );

        const data = await res.json();

        if (data.message?.success) {
            msg.innerHTML =
              "<span class='text-green-600'>Issue submitted successfully</span>";
            setTimeout(() => location.href = `/issue-detail?name=${data.message.issue_name}`, 1200);
        } else {
            throw data;
        }
    } catch (e) {
        msg.innerHTML =
          "<span class='text-red-600'>Submission failed</span>";
        console.error(e);
    }
}
</script>

{% endblock %}
