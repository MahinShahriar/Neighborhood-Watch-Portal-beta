{% extends "templates/pages/base.html" %}

{% block content %}

<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Feed</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

</head>
<body class="bg-gray-50"> -->

<div class="max-w-3xl mx-auto p-6">

    <h2 class="text-3xl font-semibold mb-6">Community Feed</h2>

    <!-- Post Form -->
    <form id="PostForm" class="space-y-4" enctype="multipart/form-data" action="">
        <div class="mb-6 p-4 bg-white shadow rounded">

            <textarea id="message" rows="3" class="w-full p-2 border rounded mb-2" placeholder="Share something..."></textarea>
            <div> 
                <label class="block mb-1 font-medium">Upload File</label> 
                <input type="file" id="file" class="w-full" accept=".jpg,.jpeg,.png,.pdf" onchange="previewFile()" />
                <img id="preview" class="mt-2 hidden max-h-60 rounded border" /> 
            </div> </br>
            <button onclick="submitPost()" class="bg-blue-600 text-white px-10 py-2 rounded hover:bg-blue-700">Post</button>
            <p id="msg" class="mt-2"></p>
        </div>
    </form>
    <div class="mt-6 text-center">
        <a href="/community-feed/all" 
           class="inline-block bg-gray-300 text-black px-7 py-1 rounded-lg shadow hover:bg-gray-500 transition">
           View All Posts
        </a>
    </div>
    <!-- Feed -->
    <div id="feed" class="space-y-4">
        <p class="text-gray-500 mb-4">Recent posts</p>

        {% for post in posts %}
        <a href="/community-feed/detail?name={{ post.name }}"
        class="block bg-white border rounded-lg p-4 shadow-sm hover:bg-gray-50 transition">

            <!-- Header -->
            <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-gray-800">{{ post.posted_by }}</span>
                <span class="text-xs text-gray-400">{{ post.creation.strftime("%d %b %Y %I:%M %p") }}</span>
            </div>

            <!-- Message -->
            <p class="text-gray-700 mb-2">
                {{ post.message }}
            </p>

            <!-- Attachment (optional) -->
            {% if post.attachments %}
                <img src="{{ post.attachments }}"
                    class="w-50% max-h-30 object-cover rounded-md mt-2">
            {% endif %}

        </a>
        {% endfor %}
    </div>


    

</div>

<script>
    function previewFile() {
    const file = document.getElementById("file").files[0];
    const preview = document.getElementById("preview");

    if (!file || !file.type.startsWith("image/")) { 
        preview.classList.add("hidden");
        return;
    }

    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
}


    async function submitPost() {
    const msg = document.getElementById("msg");

    const fd = new FormData();
    fd.append("message", document.getElementById("message").value);

    const fileInput = document.getElementById("file");
    if (fileInput.files.length > 0) {
        fd.append("file", fileInput.files[0]);
    }

    msg.innerHTML = "Submitting...";

    try {
        const res = await fetch(
            "/api/method/neighborhood_watch.api.feed_api.post_feed_message",
            {
                method: "POST",
                body: fd,
                credentials: "same-origin"
            }
        );

        const data = await res.json();

        if (data.message?.success) {
            msg.innerHTML =
              "<span class='text-green-600'>Postedsuccessfully</span>";
            setTimeout(() => location.href = `/community-feed/detail?name=${data.message.post_id}`, 900);
        } else {
            throw data;
        }
    } catch (e) {
        msg.innerHTML =
          "<span class='text-red-600'>Submission failed</span>";
        console.error(e);
    }
}
</script>
{% endblock %}