<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Neighborhood Watch{% endblock %}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Frappe JS CDN -->

    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-50">

<!-- NAVBAR -->
<nav class="fixed bg-white/80 backdrop-blur shadow-md px-6 py-4 flex items-center justify-between rounded-xl mx-4 mt-4 relative">
  <div class="flex items-center gap-6 relative">
    <a href="/home" class="nav-link relative">Home</a>
    <a href="/community-feed" class="nav-link relative">Feed</a>
    <a href="/report-issue" class="nav-link relative">Report Issue</a>
    <a href="/my-issues" class="nav-link relative">My Issues</a>
    <a href="/announcement" class="nav-link relative">Announcements</a>
    <a href="/emergency" class="nav-link  font-medium relative">Emergency</a>

    <!-- Underline -->
    <span id="nav-underline" class="absolute bottom-0 left-0 h-0.5 bg-gray-400 rounded transition-all duration-300"></span>
  </div>

  <!-- Notification Button -->
  <button onclick="toggleNotifications()" class="relative p-2 rounded-full hover:bg-gray-100">
      <span class="text-xl">ðŸ””</span>
      <span id="notif-count" class="absolute -top-1 -right-1 text-red-600 min-w-[25px] h-[18px] flex items-center justify-center rounded-full"></span>
  </button>
</nav>
<!-- NOTIFICATION PANEL -->
<div id="notification-panel" class="fixed top-0 right-0 w-80 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
    <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-semibold text-lg">Notifications</h3>
        <button onclick="toggleNotifications()">âœ–</button>
    </div>
    <div id="notification-list" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm">
        <p class="text-gray-400">Loading...</p>
    </div>
    <div class="p-3 border-t text-center text-xs text-gray-400">
        Latest updates from your community
    </div>
</div>

<main class="p-6">
    {% block content %}{% endblock %}
</main>
<script>
    const links = document.querySelectorAll('.nav-link');
const underline = document.getElementById('nav-underline');
const currentPath = window.location.pathname;

// Function to position underline
function moveUnderline(el) {
    const rect = el.getBoundingClientRect();
    const parentRect = el.parentElement.getBoundingClientRect();
    underline.style.width = rect.width + 'px';
    underline.style.transform = `translateX(${rect.left - parentRect.left}px)`;
}

// Initialize underline on current page
links.forEach(link => {
    if (link.getAttribute('href') === currentPath) {
        moveUnderline(link);
    }

    // Hover effect
    link.addEventListener('mouseenter', () => moveUnderline(link));
});

document.querySelector('nav').addEventListener('mouseleave', () => {
    // Return to active page underline
    links.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            moveUnderline(link);
        }
    });
});

let notificationsLoaded = false;
const currentUser = "{{ frappe.session.user }}";

function toggleNotifications() {
    const panel = document.getElementById("notification-panel");
    const opening = panel.classList.contains("translate-x-full");

    panel.classList.toggle("translate-x-full");

    if (opening && !notificationsLoaded) {
        loadNotifications();
        notificationsLoaded = true;
    }
}

async function loadNotifications() {
    const list = document.getElementById("notification-list");
    list.innerHTML = `<p class="text-gray-400">Loading...</p>`;

    try {
        const url = `/api/resource/Notification%20Log` +
            `?fields=["name","subject","creation","read","document_name","document_type"]` +
            `&filters=[["owner","=","${currentUser}"]]` +
            `&order_by=creation desc&limit_page_length=30`;

        const res = await fetch(url, { credentials: "include" });
        const json = await res.json();
        const rows = json.data || [];

        if (!rows.length) {
            list.innerHTML = `<p class="text-gray-400">No notifications</p>`;
            return;
        }

        // unread badge
        const badge = document.getElementById("notif-count");
        const unread = rows.filter(r => !r.read).length;
        badge.textContent = unread;
        badge.classList.toggle("hidden", unread === 0);

        list.innerHTML = "";

        rows.forEach(n => {
            const item = document.createElement("a");
            item.href = "#";
            item.className = `relative block border rounded p-2 hover:bg-gray-50 ${n.read ? "" : "bg-gray-100"}`;
            item.innerHTML = `
                ${!n.read ? `<span class="absolute top-2 right-2 w-2 h-2 bg-blue-400 rounded-full"></span>` : ""}
                <p class="font-medium pr-4">${n.subject}</p>
                <p class="text-xs text-gray-400">${new Date(n.creation).toLocaleString()}</p>
            `;

            item.onclick = async (e) => {
                e.preventDefault();

                // mark as read
                if (!n.read) {
                    await markAsRead(n.name);
                    item.classList.remove("bg-gray-100");
                    badge.textContent = Math.max(0, badge.textContent - 1);
                }

                // redirect
                if (!n.document_name || !n.document_type) return;

                let target = "#";
                if (n.document_type === "Issue Report") {
                    target = `/issue-detail?name=${n.document_name}`;
                } else if (n.document_type === "Announcement") {
                    target = `/announcement/detail?name=${n.document_name}`;
                }

                if (target !== "#") {
                    window.location.href = target;
                }
            };

            list.appendChild(item);
        });

    } catch (err) {
        console.error(err);
        list.innerHTML = `<p class="text-red-400">Failed to load notifications</p>`;
    }
}
loadNotifications(); // this line ruined my 1 hour of debugging because it loads notifications on page load .
async function markAsRead(name) {
    try {
        await fetch(`/api/resource/Notification%20Log/${name}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ read: 1 })
        });
    } catch (err) {
        console.error("Failed to mark as read", err);
    }
}


// document.addEventListener("DOMContentLoaded", () => {
//     waitForFrappe(() => {
//         frappe.realtime.on("new_notification", () => {
//             loadNotifications();
//             frappe.show_alert({ message: __("New notification"), indicator: "blue" });
//         });
//     });
// });
</script>


</body>
</html>
